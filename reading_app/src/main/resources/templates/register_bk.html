<!-- 登録フォーム -->
<h1>ユーザー登録</h1>
<p>ユーザー名とパスワードを入力してください。</p>
<!-- エラーメッセージ -->
<!-- ${error}が存在する場合のみ表示　現在はユーザー名重複の場合のみ -->
<p th:if="${error}" th:text="${error}"></p>
<br>
<!-- beforeSubmit()を使って自由入力の値とラジオボタンの値を両立 -->
<form th:action="@{/register}" method="post" th:object="${userForm}" onsubmit="return beforeSubmit();">
    <div>
        <label>ユーザー名: <input type="text" th:field="*{username}" required></label>
    </div>
    <div>
        <label>パスワード: <input type="password" th:field="*{password}" required></label>
    </div>

    <br>以下の項目については、ユーザー登録時に設定した内容が、ログイン時の問題生成フォームのプリセットとして設定されるようになります。
    <br>後でマイページから変更することも可能です。<br>
    <br>
    <!-- 難易度 (CEFR) -->
    <div class="field">
        <label>難易度 (CEFR):</label><br />
        <div th:each="lvl : ${levels}">
            <label th:switch="${lvl}">
                <input type="radio" th:field="*{difficulty}" th:value="${lvl}" />
                <span th:case="'Below A1'">入門（目安：英検5～4級）</span>
                <span th:case="'A1'">A1（目安：英検3級／TOEIC 300）</span>
                <span th:case="'A2'">A2（目安：英検準2級／TOEIC 450）</span>
                <span th:case="'B1'">B1（目安：英検2級／TOEIC 600）</span>
                <span th:case="'B2'">B2（目安：英検準1級／TOEIC 800）</span>
                <span th:case="'C1'">C1（目安：英検1級／TOEIC 950）</span>
                <span th:case="'C2'">C2（目安：英検1級+α／TOEIC 990+α）</span>
                <span th:case="'Over C2'">超上級（目安：英語ネイティブの大人でも難しい）</span>
                <span th:case="*"><span th:text="${lvl}">?</span></span>
            </label>
        </div>
    </div>
    <br>
<!-- 希望語数 -->
<div class="field">
  <label>希望語数:</label><br/>
  <div th:each="cnt : ${defaultWordCounts}">
    <label>
      <input type="radio" name="wordCountRadio" th:field="*{wordCount}" th:value="${cnt}" onchange="toggleCustomWordCount(this)" />
      <span th:text="${cnt}" />語
    </label>
  </div>
  <!-- 自由入力 -->
        <label>
            <input type="radio" name="wordCountRadio" th:field="*{wordCount}" value="0"
                onchange="toggleCustomWordCount(this)" />
            自由入力：
            <input type="number" id="customWordCount" name="customWordCount" min="1" max="2000" placeholder="希望語数"
                class="free-word-input" disabled />
            語（1～2000の整数）
        </label>
        <!-- hiddenフィールドがDTOのwordCountにname属性で対応  ラジオボタンの値と自由入力の値を内部的にこちらに統一 -->
        <input type="hidden" id="wordCountFinal" name="wordCount" value="" />
    </div>
    <br>
    <!-- 選択式問題の数 -->
    <div class="field">
        <label>選択式問題の数:</label><br />
        <div th:each="num : ${defaultQuestionCounts}">
            <label>
                <input type="radio" name="questionCountRadio" th:field="*{questionCount}" th:value="${num}"
                    onchange="toggleCustomQuestionCount(this)" />
                <span th:text="${num}" />問
            </label>
        </div>
        <!-- 自由入力 -->
        <label>
            <input type="radio" name="questionCountRadio" th:field="*{questionCount}" value="0"
                onchange="toggleCustomQuestionCount(this)" />
            自由入力：
            <input type="number" id="customQuestionCount" name="customQuestionCount" min="1" max="10"
                placeholder="希望問題数" class="free-word-input" disabled />
            問（1～10の整数）
        </label>
        <!-- hiddenフィールドがDTOのwordCountにname属性で対応  ラジオボタンの値と自由入力の値を内部的にこちらに統一 -->
        <input type="hidden" id="questionCountFinal" name="questionCount" value="" />
    </div>
    <br>
    <!-- トピック -->
    <div class="field">
        <label for="topic">トピック（任意）:</label><br />
        <input type="text" th:field="*{topic}" placeholder="例: AIを活用した英語学習" />
        <br />空欄でユーザー登録した場合、ログイン時も空欄（ランダム）になります。
    </div>
    <br>
    <button type="submit">ユーザー登録</button>
</form>


<script>
    //自由入力欄の有効/無効制御
    function toggleCustomWordCount(radio) {
        document.getElementById('customWordCount').disabled = (radio.value != 0);
    }
    function toggleCustomQuestionCount(radio) {
        document.getElementById('customQuestionCount').disabled = (radio.value != 0);
    }

    // hiddenフィールドに値をセットすることで、ラジオボタン選択での値入力と自由入力での値入力を両立させる
    function beforeSubmit() {

        // 希望語数
        var wordCountRadio = document.querySelector('input[name="wordCount"]:checked');
        //確認用
            if (!wordCountRadio) {
        alert('wordCountRadioがnullです');
        return false;
    }
        // ラジオボタンの値が0（自由入力）ならカスタムの値を～Finalにセット
        if (wordCountRadio.value === "0") {
            // 自由入力値
            document.getElementById('wordCountFinal').value = document.getElementById('customWordCount').value;
        } else {
            // ラジオの値
            document.getElementById('wordCountFinal').value = wordCountRadio.value;
        }

        // 選択式問題の数
        var questionCountRadio = document.querySelector('input[name="questionCount"]:checked');
        //確認用
    if (!questionCountRadio) {
        alert('questionCountRadioがnullです');
        return false;
    }
        // ラジオボタンの値が0（自由入力）ならカスタムの値を～Finalにセット
        if (questionCountRadio.value === "0") {
            document.getElementById('questionCountFinal').value = document.getElementById('customQuestionCount').value;
        } else {
            document.getElementById('questionCountFinal').value = questionCountRadio.value;
        }

        // 確認用に値を出力
        alert('テスト語数: ' + document.getElementById('wordCountFinal').value);
        alert('テスト設問数: ' + document.getElementById('questionCountFinal').value);
        return true;
    }

</script>