<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>出題ページ</title>
  <style>
    /* 線がはみ出るのを防止する用 どの要素にも適用 */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      /* フォント指定 */
      margin: 1em;
      /* 外側に余白 */
    }


    /* CSSの基本構文 
    セレクタ {
    プロパティ: 値;
    プロパティ: 値;
    }
    
    セレクタ … HTMLのどの要素にスタイルを適用するかを指定する部分
      ・タグセレクタ
      例: p { ... }
      → <p>〜</p> すべてに適用

      ・クラスセレクタ（.）
      例: .header-container { ... }
      → class="header-container" が付いている要素に適用

      ・IDセレクタ（#）
      例: #timer { ... }
      → id="timer" が付いている要素に適用

    { ... } の中 … その要素に対して適用する「ルール（プロパティと値の組み合わせ）」
    */

    /* ヘッダーとタイマー */
    .header-container {
      position: relative;
      margin-bottom: 1em;
    }

    /* .header-container は、class="header-container" を持つHTML要素を選択 */
    /* 「position」プロパティ：HTML要素の配置ルールを決める */

    .header-container h1 {
      display: inline-block;
    }

    #timer {
      position: relative;
      top: 0;
      right: 0;
      font-size: 0.8em;
      color: #555;
    }

    /* レイアウト */
    .flex-container {
      display: flex; /* 横並び */
      gap: 1em; /* 要素間の隙間 */
    }

    .passage,
    .questions {
      border: 1px solid #ccc;
      padding: 1em;
      overflow-y: auto; /* 内容が多いときスクロール */
    }

    .passage {
      flex: 1 1 50%; /* 幅を50%ずつ */
      max-height: 80vh;
    }

    .questions {
      flex: 1 1 50%;
      max-height: 80vh;
    }

    /* デフォルトはPC想定：左右並び */
    .flex-container {
      display: flex;
      gap: 1em;
      flex-direction: row;
    }

    .passage,
    .questions {
      flex: 1 1 50%;
      max-height: 80vh;
    }

    /* スマホ（768px以下）では縦並びに */
    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column;
      }

      .passage,
      .questions {
        /* スマホでは縦並びにしたいので、PC版レイアウトにあるフレックスの伸縮・縮小の性質を解除 */
        flex: none;
        /* スマホでは縦並びなので、横幅は半分じゃなくて画面いっぱい */
        width: 100%;
        /* PC表示では max-height: 80vh;　vh = viewport height の略 → 画面の高さに対する割合のパーセント*/
        max-height: 40vh;
      }
    }

    /* MCQ（Multiple Choice Questions：選択式の問題） */
    .mcq {
      margin-bottom: 1em;
    }

    /* 「クラス名 mcq-options を持つ要素の中にある <label> 要素」 を対象にする */
    .mcq-options label {
      display: block;
      /* display プロパティは要素の表示方法を指定する */
      /* inline（インライン要素） → 横に並ぶ、幅・高さの指定が効かない（例: <span>、<a>） */
      /* block（ブロック要素） → 縦に並ぶ、横幅いっぱいに広がる（例: <div>、<p>、<h1>） */
      /* <label> タグは、通常は inline要素 として扱われるため、ここでは縦に並べることを明示 */
    }

    /* 語数表示・入力カウンタ */
    #passageWordCount,
    #compositionWordCount {
      font-size: 0.8em;
      color: #555;
      margin-top: 0.5em;
    }

    /* ラジオボタンをスマホだけ大きくする */
    @media (max-width: 768px) {
      input[type="radio"] {
        transform: scale(1.25);
        /* テキストとの間の余白も調整 */
        margin-right: 6px;
        /* 縦位置も調整（任意） */
        vertical-align: middle;
      }
    }

    /* ヘッダー部分のレイアウト */
    h1 {
      margin-top: 0em;
      margin-bottom: 0.5em;
      padding-top: 0;
      padding-bottom: 0;
      font-size: 1em;
    }
  </style>
</head>

<body>
  <!-- ヘッダー -->
  <div class="header-container">
    <h1>出題ページ</h1>
  </div>

  <!-- 左右2カラムのレイアウト -->
  <!-- スマホの場合はflex-direction: column;で上下にする -->
  <div class="flex-container">
    <!-- 左: 問題文 -->
    <div class="passage">
      <h2><strong><em th:text="${task.title}">記事タイトル</em></strong></h2>
      <p th:text="${task.passage}">ここに英語の長文が表示されます。</p>
      <div id="passageWordCount">(0 words)</div>
    </div>

    <!-- 右: 選択式＋英作文 -->
    <div class="questions">
      <form th:action="@{/submitAnswers}" method="post">
        <!-- 隠しフィールドで、カウントした語数をフィードバック画面での表示用に送信しておく -->
        <input type="hidden" id="passageWordCountInput" name="passageWordCount" value="0" />
        <!-- 選択式問題 -->
        <h2>選択式問題</h2>
        <div th:each="mcq,iterStat : ${task.mcqs}" class="mcq">
          <p>
            <strong th:text="${(iterStat.index + 1) + '. ' + mcq.question}">
              質問文
            </strong>
          </p>
          <div class="mcq-options" th:each="opt,optStat : ${mcq.options}">
            <label>
              <input type="radio" th:name="${'mcq_' + iterStat.index}"
                th:value="${'ABCD'.substring(optStat.index, optStat.index + 1)}" required />
              <!-- 選択肢のラベル(A)～(D)はここで付与 -->
              <span th:text="${'(' + 'ABCD'.substring(optStat.index, optStat.index + 1) + ') ' + opt}" />
              <!-- ↑は閉じタグなしの記法　↓は閉じタグありの記法　↑を使う場合は</span>はなくてもよい -->
              <!-- <span th:text="${'(' + 'ABCD'.substring(optStat.index, optStat.index + 1) + ') ' + opt}"> -->
              </span>
            </label>
          </div>
        </div>

        <!-- 英作文問題 -->
        <h2>英作文問題</h2>
        <p th:text="${task.compositionPrompt}">ここに英作文問題の指示が表示されます。</p>
        <textarea id="compositionAnswer" name="compositionAnswer" rows="10" style="width:100%;"></textarea>
        <div id="compositionWordCount">(words count: 0)</div>
        <div id="timer">(time passed: 00:00)</div>
        <br>
        <button type="submit">回答を送信</button>
      </form>
    </div>
  </div>

  <script>
    // --- タイマー処理 ---
    const timerEl = document.getElementById('timer');
    const startTime = Date.now(); // 開始時間を記録
    function updateTimer() {
      const diff = Math.floor((Date.now() - startTime) / 1000); // 経過秒数
      const mm = String(Math.floor(diff / 60)).padStart(2, '0'); // 分
      const ss = String(diff % 60).padStart(2, '0'); // 秒
      timerEl.textContent = `(time passed: ${mm}:${ss})`; // 表示更新
    }
    setInterval(updateTimer, 1000); // 1秒ごとに実行
    updateTimer(); // 初回実行

    // --- 単語数カウント関数（空白で分割してカウント） ---
    function countWords(text) {
      const trimmed = text.trim();
      return trimmed ? trimmed.split(/\s+/).length : 0;
    }

    // --- 問題文の語数表示 ---
    window.addEventListener('load', () => {
      const passageText = document.querySelector('.passage p').textContent;
      const wc = countWords(passageText);
      document.getElementById('passageWordCount')
        .textContent = `(${wc} words)`;
      // フォーム送信用hiddenにもセット
      document.getElementById('passageWordCountInput').value = wc;
    });

    // --- 英作文テキストエリアの語数リアルタイムカウント ---
    const compositionArea = document.getElementById('compositionAnswer');
    const compositionCountEl = document.getElementById('compositionWordCount');
    compositionArea.addEventListener('input', () => {
      const wc = countWords(compositionArea.value);
      compositionCountEl.textContent = `(words count: ${wc})`;
    });
  </script>
</body>

</html>